#!/usr/bin/env bash
#------------------------------------------
# try-until-or-die - Wait for an expression to succeed until a specified time.

thisdir=$(dirname $BASH_SOURCE)
. $thisdir/common.sh

if [[ "$1" =~ --?h.* ]]
then
  cat <<EOF
$0 - Wait for an expression to succeed until a specified time.
     Die if it times out.

Usage: $0 end_timestamp time_between_attempts expression

Where:
  end_timestamp          The timestamp, in Unix epoch seconds, when it should give up.
                         After this point in time, the process exits.
  time_between_attempts  How long to wait between attempts. Format is "Nx".
                         See "to-seconds --help" for the required format.
  expression             The remaining arguments are the bash expression to try on
                         every iteration. It must return a status of 0 when evaluated
                         to indicate success and nonzero for failure. For example,
                         "ls foo" returns 0 if "foo" exists, otherwise it returns 1.

Contrast with "try-until", "try-for", and "try-for-or-die".
NOTES: 
  1) The process will sleep between attempts.
  2) If you don't want the expression's output, redirect to "/dev/null".
EOF
exit 0
fi

_do_try_until 1 "$@"
