<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MakeAndBashNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
/* 
   This document has been created with Marked.app <http://markedapp.com>, Copyright 2011 Brett Terpstra
   Please leave this notice in place, along with any additional credits below.
   ---------------------------------------------------------------
   Title: GitHub
   Author: Brett Terpstra
   Description: Github README style. Includes theme for Pygmentized code blocks.
*/
html,body{color:black}*{margin:0;padding:0}body{font:13.34px helvetica,arial,freesans,clean,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.4;padding:3px;background:#fff;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px}p{margin:1em 0}a{color:#4183c4;text-decoration:none}#wrapper{background-color:#fff;border:3px solid #eee!important;padding:0 30px;margin:15px}#wrapper{font-size:14px;line-height:1.6}#wrapper>*:first-child{margin-top:0!important}#wrapper>*:last-child{margin-bottom:0!important}h1,h2,h3,h4,h5,h6{margin:0;padding:0}h1{margin:15px 0;padding-bottom:2px;font-size:24px;border-bottom:1px solid #eee}h2{margin:20px 0 10px 0;font-size:18px}h3{margin:20px 0 10px 0;padding-bottom:2px;font-size:14px;border-bottom:1px solid #ddd}h4{font-size:14px;line-height:26px;padding:18px 0 4px;font-weight:bold;text-transform:uppercase}h5{font-size:13px;line-height:26px;padding:14px 0 0;font-weight:bold;text-transform:uppercase}h6{color:#666;font-size:14px;line-height:26px;padding:18px 0 0;font-weight:normal;font-variant:italic}hr{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;border:0 none;color:#ccc;height:4px;margin:20px 0;padding:0}#wrapper>h2:first-child,#wrapper>h1:first-child,#wrapper>h1:first-child+h2{border:0;margin:0;padding:0}#wrapper>h3:first-child,#wrapper>h4:first-child,#wrapper>h5:first-child,#wrapper>h6:first-child{margin:0;padding:0}h4+p,h5+p,h6+p{margin-top:0}li p.first{display:inline-block}ul,ol{margin:15px 0 15px 25px}ul li,ol li{margin-top:7px;margin-bottom:7px}ul li>*:last-child,ol li>*:last-child{margin-bottom:0}ul li>*:first-child,ol li>*:first-child{margin-top:0}#wrapper>ul,#wrapper>ol{margin-top:21px;margin-left:36px}dl{margin:0;padding:20px 0 0}dl dt{font-size:14px;font-weight:bold;line-height:normal;margin:0;padding:20px 0 0}dl dt:first-child{padding:0}dl dd{font-size:13px;margin:0;padding:3px 0 0}blockquote{margin:14px 0;border-left:4px solid #ddd;padding-left:11px;color:#555}table{border-collapse:collapse;margin:20px 0 0;padding:0}table tr{border-top:1px solid #ccc;background-color:#fff;margin:0;padding:0}table tr:nth-child(2n){background-color:#f8f8f8}table tr th,table tr td{border:1px solid #ccc;text-align:left;margin:0;padding:6px 13px}img{max-width:100%;height:auto}code,tt{margin:0 2px;padding:2px 5px;white-space:nowrap;border:1px solid #ccc;background-color:#f8f8f8;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;font-size:12px}pre>code{margin:0;padding:0;white-space:pre;border:0;background:transparent;font-size:13px}.highlight pre,pre{background-color:#f8f8f8;border:1px solid #ccc;font-size:13px;line-height:19px;overflow:auto;padding:6px 10px;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px}#wrapper>pre,#wrapper>div.highlight{margin:10px 0 0}pre code,pre tt{background-color:transparent;border:0}#wrapper{background-color:#fff;border:1px solid #cacaca;padding:30px}.poetry pre{font-family:Georgia,Garamond,serif!important;font-style:italic;font-size:110%!important;line-height:1.6em;display:block;margin-left:1em}.poetry pre code{font-family:Georgia,Garamond,serif!important}sup,sub,a.footnote{font-size:1.4ex;height:0;line-height:1;vertical-align:super;position:relative}sub{vertical-align:sub;top:-1px}@media print{body{background:#fff}img,pre,blockquote,table,figure{page-break-inside:avoid}#wrapper{background:#fff;border:0}code{background-color:#fff;color:#444!important;padding:0 .2em;border:1px solid #dedede}pre code{background-color:#fff!important;overflow:visible}pre{background:#fff}}@media screen{body.inverted,.inverted #wrapper,.inverted hr .inverted p,.inverted td,.inverted li,.inverted h1,.inverted h2,.inverted h3,.inverted h4,.inverted h5,.inverted h6,.inverted th,.inverted .math,.inverted caption,.inverted dd,.inverted dt,.inverted blockquote{color:#eee!important;border-color:#555}.inverted td,.inverted th{background:#333}.inverted pre,.inverted code,.inverted tt{background:#444!important}.inverted h2{border-color:#555}.inverted hr{border-color:#777;border-width:1px!important}::selection{background:rgba(157,193,200,.5)}h1::selection{background-color:rgba(45,156,208,.3)}h2::selection{background-color:rgba(90,182,224,.3)}h3::selection,h4::selection,h5::selection,h6::selection,li::selection,ol::selection{background-color:rgba(133,201,232,.3)}code::selection{background-color:rgba(0,0,0,.7);color:#eee}code span::selection{background-color:rgba(0,0,0,.7)!important;color:#eee!important}a::selection{background-color:rgba(255,230,102,.2)}.inverted a::selection{background-color:rgba(255,230,102,.6)}td::selection,th::selection,caption::selection{background-color:rgba(180,237,95,.5)}.inverted{background:#0b2531}.inverted #wrapper,.inverted{background:rgba(37,42,42,1)}.inverted a{color:rgba(172,209,213,1)}}.highlight .c{color:#998;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#998;font-style:italic}.highlight .cp{color:#999;font-weight:bold}.highlight .c1{color:#998;font-style:italic}.highlight .cs{color:#999;font-weight:bold;font-style:italic}.highlight .gd{color:#000;background-color:#fdd}.highlight .gd .x{color:#000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000;background-color:#dfd}.highlight .gi .x{color:#000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#800080;font-weight:bold}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kn{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#458;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:#008080}.highlight .nb{color:#0086b3}.highlight .nc{color:#458;font-weight:bold}.highlight .no{color:#008080}.highlight .ni{color:#800080}.highlight .ne{color:#900;font-weight:bold}.highlight .nf{color:#900;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#099}.highlight .gc{color:#999;background-color:#eaf2f5}.type-csharp .highlight .k{color:#00F}.type-csharp .highlight .kt{color:#00F}.type-csharp .highlight .nf{color:#000;font-weight:normal}.type-csharp .highlight .nc{color:#2b91af}.type-csharp .highlight .nn{color:#000}.type-csharp .highlight .s{color:#a31515}.type-csharp .highlight .sc{color:#a31515}
</style>

</head>
<body class="normal">
  <div id="wrapper">
      <h1 id="makeandbashnotes">Make and Bash Notes</h1>

<p>This document offers some tips on using <code>bash</code> and <code>make</code> effectively to build stampedes. The <code>bash</code> scripts and <code>Makefiles</code> that come with <em>Stampede</em>, e.g., in the <code>bin</code> and <code>examples</code> directories, also provide examples.</p>

<p>This is by no means a complete tutorial on either tool. </p>

<h2 id="makenotes">Make Notes</h2>

<p>While many of these points apply to all implementations of <code>make</code>, we&#8217;ll focus on GNU <code>make</code>, the version of <code>make</code> distributed with Linux and Mac OSX and the only <code>make</code> supported by <em>Stampede</em>. See the <a href="http://www.gnu.org/software/make/manual/">GNU Make Manual</a> for more information.</p>

<h3 id="parallelvs.sequentialexecution">Parallel vs. Sequential Execution</h3>

<p>Consider the following <code>Makefile</code>:</p>

<pre><code>all: one two three
    @echo &quot;$@ finished!&quot;

one two three:
    @echo &quot;building $@...&quot;
    sleep 1
    @echo &quot;$@ finished!&quot;
</code></pre>

<p>The <code>@</code> before <code>echo</code> means &#8220;don&#8217;t print this command to stdout before running it.&#8221; This reduces output clutter, especially for an <code>echo</code> command that itself writes output!</p>

<p>The <code>$@</code> variable references the target. For example, when <code>all</code> finishes, <code>@echo &quot;$@ finished!&quot;</code> will print &#8220;all finished!&#8221;.</p>

<p>If you build the <code>all</code> target by just running <code>make</code> (which will look for <code>Makefile</code> by default), you get this output:</p>

<pre><code>building one...
sleep 1
one finished!
building two...
sleep 1
two finished!
building three...
sleep 1
three finished!
all finished!
</code></pre>

<p>Note that <code>one</code>, <code>two</code>, and <code>three</code> where built sequentially, one at a time, as &#8220;suggested&#8221; by the dependency list for <code>all</code>. Note that for each of the <code>one</code>, <code>two</code>, and <code>three</code> targets, the output for each was the following: </p>

<pre><code>building &lt;X&gt;...
sleep 1
&lt;X&gt; finished!
</code></pre>

<p>However, this sequential ordering is misleading. It only happened this way because <code>make</code> runs sequentially by default.</p>

<p>The <code>Makefile</code> actually says that <code>all</code> depends on the other three targets, but they have no dependencies on each other. You can see this if you run <code>make --jobs</code>, which causes <code>make</code> to build as many targets concurrently as the dependency tree will allow. Here is the output of one run:</p>

<pre><code>building two...
building one...
sleep 1
sleep 1
building three...
sleep 1
one finished!
two finished!
three finished!
all finished!
</code></pre>

<p>Note that the three output lines for each of <code>one</code>, <code>two</code>, and <code>three</code> are now intertwined. Make recognized that these targets are independent and it built them concurrently. In fact, different runs will show a different ordering of the output, except for the last line.</p>

<p><strong>By default</strong>, <em>Stampede</em> passes the <code>--jobs</code> option to <code>make</code> to exploit concurrency when possible. This is configurable in your project&#8217;s <code>.stampederc</code> file by setting the <code>STAMPEDE_MAKE_OPTIONS</code> environment variable.</p>

<p>All this means two things:</p>

<ul>
<li>When your stampedes include long-running or long-waiting tasks, other unrelated work can proceed.</li>
<li>Be careful that you construct your dependencies correctly and don&#8217;t rely on the informal, but incorrect, dependencies implied by a dependency list when running in <code>make</code>&#8217;s default synchronous mode (i.e., when <code>--jobs</code> isn&#8217;t used).</li>
</ul>

<p>So, in our <code>Makefile</code>, if <code>three</code> really depends on <code>two</code>, and <code>two</code> really depends on <code>one</code>, then the <code>Makefile</code> should be rewritten as follows:</p>

<pre><code>all1: three
    @echo &quot;$@ finished!&quot;

three: two
two: one

one two three:
    @echo &quot;building $@...&quot;
    sleep 1
    @echo &quot;$@ finished!&quot;
</code></pre>

<p>Actually, we used a useful GNU <code>make</code> technique here; we specified <code>three</code> and <code>two</code> as targets twice, once to specify their dependents and again to specify the common commands used to build <code>one</code>, <code>two</code>, and <code>three</code>.</p>

<p>If you run <code>make --jobs</code> with this version of <code>Makefile</code>, you&#8217;ll still get the synchronous output.</p>

<h1 id="settingmakevariableswithshellcommandsorfileglobs">Setting Make Variables with Shell Commands or File &#8220;Globs&#8221;</h1>

<p>In GNU <code>make</code>, you can run shell commands and file &#8220;globs&#8221; as follows:</p>

<pre><code>EPOCH_SECONDS = $(shell date +%s)
SH_FILES      = $(wildcard bin/*.sh)

...

show_vars:
    @echo ${EPOCH_SECONDS}
    @echo ${SH_FILES}
</code></pre>

<p>At the moment when I ran <code>make show_vars</code>, I got the following output:</p>

<pre><code>1357151251
bin/common.sh bin/env.sh bin/log.sh
</code></pre>

<p>Note that <code>make</code> variables must be referenced using the <code>${...}</code> syntax, unlike <code>bash</code> shell variables, where the <code>{</code> and <code>}</code> are only required to separate text, e.g., something like <code>${prefix}name</code>.</p>

<h2 id="bashnotes">Bash Notes</h2>

<p>A few advanced bash constructs are used. Some are briefly described here, but more complete information is readily available on the Internet. Recall that the <a href="README.html">README</a> mentioned that we have restricted ourselves to constructs in <code>bash</code> v3.X, which is the current release on Mac OSX. However, you can use <code>bash</code> v4.X constructs if you&#8217;re working exclusively on Linux systems.</p>

<h3 id="variablesthatarenumbers">Variables that Are Numbers</h3>

<pre><code>let count=0
while [ some_condition_is_true ]
do
  do_something
  let count=$count+1
done
echo &quot;Looped $count times&quot;
</code></pre>

<p>Here is another example that processes the input command arguments in <code>$@</code>, which is a <code>bash</code> array. The <code>$#</code> variable is the length of the array. <code>$1</code> is the first element. (<code>$0</code> is the path to the script we&#8217;re running, by the way.) See below for another example with user-defined arrays:</p>

<pre><code>while [ $# -gt 0 ]
do
  case $1 in
    -h|--he*)
      show_help
      exit 0
      ;;
    -f|--file)
      shift  # go to the next command-line option
      file=$1
      ;;
    ...
  esac
  shift
done
</code></pre>

<h3 id="user-definedarrays">User-defined Arrays</h3>

<p>In this variation of the previous example, we save all <code>$@</code> elements we don&#8217;t immediately process in a user-defined array. Note that <code>${#args[@]}</code> is the length of the array and <code>${args[0]}</code> is the <em>first</em> element.</p>

<pre><code>args=()  # initialize &quot;args&quot; as an empty array.
while [ $# -gt 0 ]
do
  case $1 in
    -h|--he*)
      show_help
      exit 0
      ;;
    -f|--file)
      shift  # go to the next command-line option
      file=$1
      ;;
    *)       # all other command-line options
      args[${#args[@]}]=$1   # funky notation to append to args
      ;;
  esac
  shift
done
</code></pre>

<p>Since <code>${#args[@]}</code> is the length of the array, the notation for appending to the array effectively says to write the new element to the position given by <code>${#args[@]}</code>, which is one past the current last element!</p>

<h3 id="testingthesuccessorfailureofapreviouscommand">Testing the Success or Failure of a Previous Command</h3>

<p>By convention, commands return <code>0</code> if successful and nonzero if not. Functions in <code>bash</code> should use <code>return N</code>, unless they really want to exit the whole program!</p>

<pre><code>my_command
if [ $? -ne 0 ]
then
  echo &quot;It failed!&quot;
  exit 1
fi
</code></pre>

<p>The <code>$?</code> variable is the exit status of the previously-run command (e.g., <code>my_command</code>) and it will be <code>0</code> if the command succeeded. Note, you we used <code>-ne</code> for the test instead of <code>!=</code>, because <code>$?</code> is actually a number. In fact, <code>!=</code> would have worked, too, but it would have treated <code>$?</code> and <code>0</code> as strings.</p>

<h3 id="conditionallysetavariable">Conditionally Set a Variable</h3>

<pre><code>FLAG=1
...
: ${FLAG:=0}
</code></pre>

<p>The value of <code>$FLAG</code> will be <code>1</code>. The 3rd line only assigns <code>FLAG</code> if it hasn&#8217;t already been assigned. (This is different than if FLAG were previously assigned the value of &quot;&quot;, the empty string.) The <code>:</code> is required so that bash doesn&#8217;t try to run the value <code>$FLAG</code> as a command. There are other conditional assignment constructs available for <code>bash</code>. See <code>man bash</code>, for example.</p>

<h3 id="gettheparentdirectorythatcontainsafileoranotherdirectory">Get the Parent Directory that Contains a File or Another Directory</h3>

<pre><code>FILE=/a/b/c.txt
...
dirname $FILE  # prints &quot;/a/b&quot;
</code></pre>

<h3 id="getthenameofafileordirectory">Get the Name of a File or Directory</h3>

<pre><code>FILE=/a/b/c.txt
...
basename $FILE  # prints &quot;c.txt&quot;
</code></pre>

<h3 id="assigntheoutputofonecommandtoavariable">Assign the Output of One Command to a Variable</h3>

<pre><code>FILE=/a/b/c.txt
...
BASE=$(basename $FILE)
echo $BASE      # prints &quot;c.txt&quot;
</code></pre>

<h3 id="removeaprefixorasuffixfromastring">Remove a Prefix or a Suffix from a String</h3>

<pre><code>FILE=20110601-foo-bar
...
echo ${FILE#*-}   # prints &quot;foo-bar&quot;
echo ${FILE##*-}  # prints &quot;bar&quot;
echo ${FILE%-*}   # prints &quot;20110601-foo&quot;
echo ${FILE%%-*}  # prints &quot;20110601&quot;
</code></pre>
    </div>
</body>
</html>